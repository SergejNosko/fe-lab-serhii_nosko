<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <title>JSDoc: Source: components/timer/mvc/view.js</title>

    <script src="scripts/prettify/prettify.js"> </script>
    <script src="scripts/prettify/lang-css.js"> </script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify-tomorrow.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc-default.css">
</head>

<body>

<div id="main">

    <h1 class="page-title">Source: components/timer/mvc/view.js</h1>

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>import Template from "../template/template.hbs";
import "../template/helpers";
import TimerCompleted from "../template/timer-completed.hbs";
import TimerBreak from "../template/timer-break.hbs";
import TimerProcess from "../template/timer-process.hbs";
import {Controller} from "./controller";
import Firebase from "../../../services/firebase";
import $ from "jquery";

/**
 * @module TimerComponentView
 */
export class View {
  /**
   * Initialize controller, timer, totalTime and currentState fields
   */
    constructor(data) {
        this.controller = new Controller(data);
        this.timer = null;
        this.totalTime = null;
        this.currentState = "process";
    }

    /**
     * Calculate how much time is left to finish the stage
     */
    timeLeft(title) {
        const minutes = Math.floor((this.totalTime) / 60),
            seconds = this.totalTime % 60;
        const subString = this.currentState === "break" ? "break" : "";

        if (minutes === 0) {
            title.innerHTML = `${subString}&lt;span class="timer__body-title-number">${seconds}&lt;/span> sec`;
        }
        else {
            title.innerHTML = `${subString}&lt;span class="timer__body-title-number">${minutes}&lt;/span> min`;
        }

    }

    /**
     * Starts the timer animation and change the timer state
     */
    animationStart() {
        this.totalTime = this.setIterationTime();

        const timerTitle = document.querySelector("[data-title=timer-page]");
        const timerPomodoros = document.getElementById("timer-page-pomodoros");

        timerPomodoros.innerHTML += `&lt;li class="timer__pomodoros-item">
        &lt;div class="timer__pomodoros-button timer__pomodoros-button_process icon-add" data-query="addPomodoro">&lt;/div>
      &lt;/li>`;

        this.timeLeft(timerTitle);
        this.totalTime--;

        this.timer = setInterval(() => {
            this.timeLeft(timerTitle);
            this.totalTime--;
        }, 1000);
    }

    /**
     * Ends the timer animation and change the timer state
     */
    animationEnd(status) {
        clearInterval(this.timer);

        const timer = document.getElementById("timer-page");
        const data = this.controller.getData();

        this.controller.setEstimation({status: status});

        const isFinished = this.controller.checkPomodoro();

        if (isFinished) {
            timer.innerHTML = TimerCompleted(data);
            this.viewController("visible");
            this.controller.fillRemained();
        }
        else {
            this.currentState = "break";

            timer.innerHTML = TimerBreak(data);

            this.setAnimationProperties();
        }
    }

    /**
     * Fires when timer animation ends and currentState is break
     */
    animationBreakEnd() {
        clearInterval(this.timer);

        const buttonsContainer = document.querySelector("[data-buttons=\"timer-page-break\"]");
        const timerTitle = document.querySelector("[data-title=timer-page]");

        timerTitle.innerHTML = "Break&lt;br> is over";
        buttonsContainer.innerHTML += "&lt;button class=\"button-container__item button-container__item_blue\" data-query=\"timerFinish\">Finish Task&lt;/button>";

        this.currentState = "process";
    }

    /**
     * Check the current timer iteration, set it to 1 if iteration is equal to settings work iteration property  or increase it by 1 if not
     */
    setCurrentIteration() {
        if (this.settings[4] === this.settings[1]) {
            this.settings[4] = 1;
        }
        else {
            this.settings[4]++;
        }

        Firebase.updateValue(this.settings, "settings");
    }

    /**
     * Returns an iteration time according to currentState and currentIteration
     * @return {number} iteration time
     */
    setIterationTime() {
        if (this.currentState === "process") {
            return this.settings[0];
        }
        else {
            if (this.settings[4] === this.settings[1]) {
                return this.settings[3];
            }
            return this.settings[2];
        }
    }

    /**
     * Sets animation duration property to the timer and define animationstart and animationend events
     */
    setAnimationProperties() {
        const progress = document.querySelector("[data-anim~=\"left\"]"),
            progressHalf = document.querySelector("[data-anim~=\"right\"]"),
            wrapper = document.querySelector("[data-anim~=\"wrapper\"]");

        const time = this.setIterationTime();

        progress.style.animationDuration = time + "s";
        progressHalf.style.animationDuration = time / 2 + "s";
        wrapper.style.animationDelay = time / 2 + "s";

        progress.addEventListener("animationstart", this.animationStart.bind(this));

        if (this.currentState === "process") {
            progress.addEventListener("animationend", this.animationEnd.bind(this, "finished"));
        }
        else {
            progress.addEventListener("animationend", this.animationBreakEnd.bind(this, "finished"));
        }
    }

    /**
     * Show or hide some elements on the page according to the parameter
     * @param {string} overflow - option that tells the function to hide or show some elements on the page
     */
    viewController(overflow) {
        const header = document.getElementById("main-header");
        const timerButtons = document.getElementById("timer-page-buttons");

        if (overflow === "visible") {
            timerButtons.innerHTML += "&lt;a href=\"#report\" class=\"main-content__back-button icon-arrow-right\" data-title=\"Go to Global List\">&lt;/a>";
        }

        header.style.visibility = overflow;
        timerButtons.style.visibility = overflow;
    }

    /**
     * Event handler that fires when user clicks on some elements on the page and reacts properly on these actions
     */
    handleStartTimer(e) {
        const target = e.target;

        if (!target.dataset.query) return;

        const timerData = this.controller.getData();
        const timer = document.getElementById("timer-page");

        switch (target.dataset.query) {
        case "timerStart": {
            this.viewController("hidden");
            this.currentState = "process";
            this.setCurrentIteration();

            timer.innerHTML = TimerProcess(timerData);

            this.setAnimationProperties();
            break;
        }
        case "finishPomodoro": {
            this.animationEnd.call(this, "finished");
            break;
        }
        case "failPomodoro": {
            this.animationEnd.call(this, "failed");
            break;
        }
        case "timerFinish": {
            const timer = document.getElementById("timer-page");
            const data = this.controller.getData();

            this.controller.fillRemained();

            timer.innerHTML = TimerCompleted(data);
            break;
        }
        case "addPomodoro": {
            const isAdded = this.controller.addPomodoro();

            if (isAdded) {
                const timerPomodoros = document.getElementById("timer-page-pomodoros");
                const li = document.createElement("li");

                li.innerHTML += `&lt;li class="timer__pomodoros-item">
               &lt;div class="timer__pomodoros-item_button timer__pomodoros-item_none">&lt;/div>
             &lt;/li>`;

                timerPomodoros.insertBefore(li, timerPomodoros.lastChild);
            }
        }

        }
    }

    /**
     * Render the timer template
     */
    render() {
        const timer = document.getElementById("timer-page");
        const data = this.controller.getData();

        Firebase.getData("settings").then((settings) => {
            if (data.estimationTotal === data.estimationUsed) {
                timer.innerHTML = TimerCompleted(data);
            }
            else {
                this.settings = settings;
                timer.innerHTML = Template(data);
                document.body.addEventListener("click", this.handleStartTimer.bind(this));
            }

            $("a").tooltip();
        });
    }
}
</code></pre>
        </article>
    </section>




</div>

<nav>
    <h2><a href="index.html">Home</a></h2><h3>Modules</h3><ul><li><a href="module-Header.html">Header</a></li><li><a href="module-Notification.html">Notification</a></li><li><a href="module-ReportsPage.html">ReportsPage</a></li><li><a href="module-ReportsPageController.html">ReportsPageController</a></li><li><a href="module-ReportsPageModel.html">ReportsPageModel</a></li><li><a href="module-ReportsPageView.html">ReportsPageView</a></li><li><a href="module-SettingsPageView.html">SettingsPageView</a></li><li><a href="module-SingleTask.html">SingleTask</a></li><li><a href="module-SingleTaskController.html">SingleTaskController</a></li><li><a href="module-SingleTaskModel.html">SingleTaskModel</a></li><li><a href="module-SingleTaskView.html">SingleTaskView</a></li><li><a href="module-TaskList.html">TaskList</a></li><li><a href="module-TaskListController.html">TaskListController</a></li><li><a href="module-TaskListModel.html">TaskListModel</a></li><li><a href="module-TaskListView.html">TaskListView</a></li><li><a href="module-TimerComponent.html">TimerComponent</a></li><li><a href="module-TimerComponentController.html">TimerComponentController</a></li><li><a href="module-TimerComponentModel.html">TimerComponentModel</a></li><li><a href="module-TimerComponentView.html">TimerComponentView</a></li></ul><h3>Classes</h3><ul><li><a href="module-ReportsPageController.Controller.html">Controller</a></li><li><a href="module-ReportsPageModel.Model.html">Model</a></li><li><a href="module-ReportsPageView.View.html">View</a></li><li><a href="module-SingleTaskController.Controller.html">Controller</a></li><li><a href="module-SingleTaskModel.Model.html">Model</a></li><li><a href="module-SingleTaskView.View.html">View</a></li><li><a href="module-TaskListController.Controller.html">Controller</a></li><li><a href="module-TaskListModel.Model.html">Model</a></li><li><a href="module-TaskListView.View.html">View</a></li><li><a href="module-TimerComponentController.Controller.html">Controller</a></li><li><a href="module-TimerComponentModel.Model.html">Model</a></li><li><a href="module-TimerComponentView.View.html">View</a></li><li><a href="Setting.html">Setting</a></li></ul><h3>Namespaces</h3><ul><li><a href="SettingPageController.html">SettingPageController</a></li></ul>
</nav>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.5.5</a> on Tue Jan 16 2018 01:01:26 GMT+0200 (EET)
</footer>

<script> prettyPrint(); </script>
<script src="scripts/linenumber.js"> </script>
</body>
</html>
